var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,o=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,n=(e,t)=>{for(var a in t||(t={}))s.call(t,a)&&o(e,a,t[a]);if(i)for(var a of i(t))r.call(t,a)&&o(e,a,t[a]);return e},l=(e,i)=>t(e,a(i));import{m as p,f as c,r as m,n as d,p as u,o as h,g as y,h as g,w as C,t as f,q as b,j as D}from"./vendor.fd304484.js";import{t as v,_ as L,a as x,b as w,m as I,D as _}from"./ReplyList.89be93b1.js";import{a as j}from"./index.5640ba6d.js";import{f as P}from"./index.e7d4a062.js";const R={name:"topicDetail",data:()=>({currentPage:1,isInitLoading:!1,topicDetail:{},toolbars:v,replyContent:"",replyComment:{replyId:"",replyName:"",content:""},dialog:{title:"",visible:!1}}),components:{NoData:L,ReplyList:x,Loading:w},computed:l(n(n({},p("appShell",["baseInfo"])),p("topic",["topicCommentsData"])),{isTopic(){return"topicDetail"==this.$route.name},renderConent(){if(!this.topicDetail.cont)return"";return I(this.topicDetail.cont,{highlight:e=>_.highlightAuto(e).value})},isMyTopic(){return!!this.baseInfo.is_login&&this.baseInfo.email===this.topicDetail.user.email},isNumber(){return j.numberStr(this.$route.params.id)}}),methods:l(n({},c("topic",["getTopicsDetail","createComments","fetchComments"])),{async openReplyDialog(e){const{replyId:t,replyName:a}=e;this.replyComment.replyId=t,this.replyComment.replyName=a,this.replyComment.content="@"+a+" ",this.dialog.title="回复"+a,this.dialog.visible=!0},async getTopicDetail(){const e=await this.getTopicsDetail({query:{_id:this.$route.params.id}});this.topicDetail=e.result},onReplyContent(){this.replyContent?this.reply({cont:this.replyContent,article:this.$route.params.id}):this.$message("请输入回复内容")},replyUser(e){this.reply(e)},reply(e){return new Promise(((t,a)=>{this.createComments(e).then((async e=>{if(200===e.code)return this.$message(e.msg),this.replyContent="",this.currentPage=1,this.getComments().then((()=>{t(!0)})),!1}))}))},handleCurrentChange(e){this.currentPage=e,this.getComments()},async getComments(){if(this.isNumber)return!1;await this.fetchComments({query:{article:this.$route.params.id,replyWho:{$exists:!1}},options:{limit:8,page:this.currentPage||1,sort:{date:-1},populate:"user reply replyWho"}}),console.log(this.topicCommentsData)},async onReplyComment(){if(this.replyComment.content==="@"+this.replyComment.replyName+" "||""===this.replyComment.content)return void this.$message("回复内容不能为空");await this.reply({cont:this.replyComment.content,article:this.$route.params.id,comments_id:this.replyComment.replyId})&&(this.dialog.visible=!1)},formatTime:e=>e?j.numberStr(e)?"发布于："+P(e,"yyyy-MM-dd HH:mm:ss"):e:""}),created(){this.isInitLoading=!0,this.topicDetail={},this.getTopicDetail().then((()=>{this.isInitLoading=!1})),this.getComments()},beforeDestroy(){this.topicDetail={}}},T={class:"topic-detail-wrapper"},$={class:"topic-header flex justify-between mb-8"},N={class:"d-flex my-2 meta text-gray-400"},O={class:"mr-2"},U=g("div",{class:"card-header"},[g("span",null,"回复")],-1),k={key:0,class:"pa-4"},M=g("div",{class:"card-header"},[g("span",null,"发表评论")],-1),H={class:"my-4 px-4"},S=D("评论"),q=g("div",{class:"card-header"},[g("span",null,"作者信息")],-1),V={class:"flex items-center mb-8"},z={class:"text-overflow"};R.render=function(e,t,a,i,s,r){const o=m("el-card"),n=m("replyList"),l=m("el-pagination"),p=m("no-data"),c=m("el-input"),D=m("el-button"),v=m("el-col"),L=m("el-avatar"),x=m("el-row"),w=d("loading");return u((h(),y("div",T,[g(x,{gutter:20},{default:C((()=>[g(v,{span:18},{default:C((()=>[g(o,{class:"box-card"},{default:C((()=>[g("div",$,[g("div",null,[g("h2",null,f(s.topicDetail.title),1),g("p",N,[g("span",O,f(r.formatTime(s.topicDetail.date)),1),g("span",null,"作者："+f(s.topicDetail.user?s.topicDetail.user.name||s.topicDetail.user.email:""),1)])])]),g("article",{class:"mt-4 py-4",id:"nice",innerHTML:r.renderConent},null,8,["innerHTML"])])),_:1}),r.isNumber||s.isInitLoading?b("",!0):(h(),y(o,{key:0,class:"mt-4"},{header:C((()=>[U])),default:C((()=>[e.topicCommentsData.docs&&e.topicCommentsData.docs.length?(h(),y("div",k,[g(n,{replyList:e.topicCommentsData.docs,onReplyUser:r.replyUser,author:s.topicDetail.user},{default:C((e=>[g(n,{replyList:e.item,parentList:e.parent,author:s.topicDetail.user,onReplyUser:r.replyUser},null,8,["replyList","parentList","author","onReplyUser"])])),_:1},8,["replyList","onReplyUser","author"]),g(l,{class:"mt-8 text-center",background:"","current-page":s.currentPage,"page-size":e.topicCommentsData.limit,layout:"prev, pager, next",onCurrentChange:r.handleCurrentChange,total:e.topicCommentsData.totalDocs},null,8,["current-page","page-size","onCurrentChange","total"])])):(h(),y(p,{key:1,text:"无回复"}))])),_:1})),r.isNumber?b("",!0):(h(),y(o,{key:1,class:"mt-4"},{header:C((()=>[M])),default:C((()=>[g("div",H,[g(c,{type:"textarea",class:"mb-3",placeholder:"发表评论...",modelValue:s.replyContent,"onUpdate:modelValue":t[1]||(t[1]=e=>s.replyContent=e)},null,8,["modelValue"]),g(D,{class:"my-4",type:"primary",onClick:r.onReplyContent},{default:C((()=>[S])),_:1},8,["onClick"])])])),_:1}))])),_:1}),g(v,{span:6},{default:C((()=>[g(o,{class:"box-card"},{header:C((()=>[q])),default:C((()=>[g("div",V,[g(L,{class:"mr-4",icon:"el-icon-user-solid"}),g("span",z,f(s.topicDetail.user?s.topicDetail.user.name||s.topicDetail.user.email:""),1)])])),_:1})])),_:1})])),_:1})],512)),[[w,s.isInitLoading]])};export default R;
