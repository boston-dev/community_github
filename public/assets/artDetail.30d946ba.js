var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,r=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,n=(e,t)=>{for(var a in t||(t={}))i.call(t,a)&&r(e,a,t[a]);if(s)for(var a of s(t))o.call(t,a)&&r(e,a,t[a]);return e},l=(e,s)=>t(e,a(s));import{m as p,f as c,r as m,n as d,p as u,o as h,g as y,h as g,w as C,t as f,F as b,i as D,q as k,j as v}from"./vendor.fd304484.js";import{t as _,_ as x,a as L,b as w,m as $,D as I}from"./ReplyList.137c45a2.js";import{a as j}from"./index.3d793dfd.js";import{f as P}from"./index.e7d4a062.js";const R={name:"topicDetail",data(){return{_id:this.$route.params.id,book:{docs:[]},currentPage:1,isInitLoading:!1,toolbars:_,replyContent:"",replyComment:{replyId:"",replyName:"",content:""},dialog:{title:"",visible:!1}}},components:{NoData:x,ReplyList:L,Loading:w},computed:l(n(n({},p("appShell",["baseInfo"])),p("topic",["topicCommentsData"])),{topicDetail(){let e={};return this.book.docs&&this.book.docs.length&&this.book.docs.forEach((t=>{if(t._id==this._id)return e=t,!1})),e},isTopic(){return"topicDetail"==this.$route.name},renderConent(){if(!this.topicDetail.cont)return"";return $(this.topicDetail.cont,{highlight:e=>I.highlightAuto(e).value})},isMyTopic(){return!!this.baseInfo.is_login&&this.baseInfo.email===this.topicDetail.user.email},isNumber(){return j.numberStr(this.$route.params.id)}}),methods:l(n({},c("topic",["getTopicsDetail","createComments","fetchComments"])),{async openReplyDialog(e){const{replyId:t,replyName:a}=e;this.replyComment.replyId=t,this.replyComment.replyName=a,this.replyComment.content="@"+a+" ",this.dialog.title="回复"+a,this.dialog.visible=!0},async getTopicDetail(){const e=await this.getTopicsDetail({query:{_id:this.$route.params.id}});this.topicDetail=e.result},onReplyContent(){this.replyContent?this.reply({cont:this.replyContent,article:this.$route.params.id}):this.$message("请输入回复内容")},replyUser(e){this.reply(e)},reply(e){return new Promise(((t,a)=>{this.createComments(e).then((async e=>{if(200===e.code)return this.$message(e.msg),this.replyContent="",this.currentPage=1,this.getComments().then((()=>{t(!0)})),!1}))}))},handleCurrentChange(e){this.currentPage=e,this.getComments()},async getComments(){if(this.isNumber)return!1;await this.fetchComments({query:{article:this.$route.params.id,replyWho:{$exists:!1}},options:{limit:8,page:this.currentPage||1,sort:{date:-1},populate:"user reply replyWho"}})},async onReplyComment(){if(this.replyComment.content==="@"+this.replyComment.replyName+" "||""===this.replyComment.content)return void this.$message("回复内容不能为空");await this.reply({cont:this.replyComment.content,article:this.$route.params.id,comments_id:this.replyComment.replyId})&&(this.dialog.visible=!1)},formatTime:e=>e?j.numberStr(e)?"发布于："+P(e,"yyyy-MM-dd HH:mm:ss"):e:"",async getBook(){if(this.loading=!0,!this.$route.query.cat)return!1;let e=await this.$request.post("/index/articles",{query:{cat:this.$route.query.cat},options:{sort:{date:1},populate:"user cat"}}).then((e=>e.data)).catch((e=>e));200===e.code&&(this.book=e.result),this.loading=!1}}),async created(){this.isInitLoading=!0,await this.getBook(),this.getComments(),this.isInitLoading=!1}},N={class:"topic-detail-wrapper"},O={class:"card-header"},T=g("i",{class:"el-icon-document"},null,-1),U={class:"text-overflow"},q={class:"topic-header flex justify-between mb-8"},M={class:"d-flex my-2 meta text-gray-400"},H={class:"mr-2"},S=g("div",{class:"card-header"},[g("span",null,"回复")],-1),V={key:0,class:"pa-4"},z=g("div",{class:"card-header"},[g("span",null,"发表评论")],-1),B={class:"my-4 px-4"},E=v("评论");R.render=function(e,t,a,s,i,o){const r=m("el-card"),n=m("el-col"),l=m("replyList"),p=m("el-pagination"),c=m("no-data"),v=m("el-input"),_=m("el-button"),x=m("el-row"),L=d("loading");return u((h(),y("div",N,[g(x,{gutter:20},{default:C((()=>[g(n,{span:6},{default:C((()=>[i.book.docs&&i.book.docs.length?(h(),y(r,{key:0,class:"box-card"},{header:C((()=>[g("div",O,[g("span",null,"《"+f(i.book.docs[0].cat.title)+"》目录",1)])])),default:C((()=>[(h(!0),y(b,null,D(i.book.docs,((e,t)=>(h(),y("div",{onClick:t=>i._id=e._id,class:"flex items-center mb-8",key:e._id+t},[T,g("span",U,f(e.title),1)],8,["onClick"])))),128))])),_:1})):k("",!0)])),_:1}),g(n,{span:18},{default:C((()=>[g(r,{class:"box-card"},{default:C((()=>[g("div",q,[g("div",null,[g("h2",null,f(o.topicDetail.title),1),g("p",M,[g("span",H,f(o.formatTime(o.topicDetail.date)),1),g("span",null,"作者："+f(o.topicDetail.user?o.topicDetail.user.name||o.topicDetail.user.email:""),1)])])]),g("article",{class:"mt-4 py-4",id:"nice",innerHTML:o.renderConent},null,8,["innerHTML"])])),_:1}),o.isNumber||i.isInitLoading?k("",!0):(h(),y(r,{key:0,class:"mt-4"},{header:C((()=>[S])),default:C((()=>[e.topicCommentsData.docs&&e.topicCommentsData.docs.length?(h(),y("div",V,[g(l,{replyList:e.topicCommentsData.docs,onReplyUser:o.replyUser,author:o.topicDetail.user},{default:C((e=>[g(l,{replyList:e.item,parentList:e.parent,author:o.topicDetail.user,onReplyUser:o.replyUser},null,8,["replyList","parentList","author","onReplyUser"])])),_:1},8,["replyList","onReplyUser","author"]),g(p,{class:"mt-8 text-center",background:"","current-page":i.currentPage,"page-size":e.topicCommentsData.limit,layout:"prev, pager, next",onCurrentChange:o.handleCurrentChange,total:e.topicCommentsData.totalDocs},null,8,["current-page","page-size","onCurrentChange","total"])])):(h(),y(c,{key:1,text:"无回复"}))])),_:1})),o.isNumber?k("",!0):(h(),y(r,{key:1,class:"mt-4"},{header:C((()=>[z])),default:C((()=>[g("div",B,[g(v,{type:"textarea",class:"mb-3",placeholder:"发表评论...",modelValue:i.replyContent,"onUpdate:modelValue":t[1]||(t[1]=e=>i.replyContent=e)},null,8,["modelValue"]),g(_,{class:"my-4",type:"primary",onClick:o.onReplyContent},{default:C((()=>[E])),_:1},8,["onClick"])])])),_:1}))])),_:1})])),_:1})],512)),[[L,i.isInitLoading]])};export default R;
